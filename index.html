<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Employee Training View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#f4f6f9; font-family:system-ui; transition:all .3s; }
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark .card { background:#1e1e1e; color:#e0e0e0; border:1px solid #333; }
    body.dark table th { background:#343a40; color:#fff; }
    body.dark .table { color:#e0e0e0; }
    .card { box-shadow:0 4px 12px rgba(0,0,0,.07); border:none; border-radius:12px; }
    .badge-due { background:#28a745; color:#fff; }
    .badge-over { background:#dc3545; color:#fff; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-norecord { background:#6c757d; color:#fff; }
    table th { background:#343a40; color:#fff; }
    .training-link { color:#007bff; text-decoration:underline; }
    body.dark .training-link { color:#4dabf7; }
    .schedule-training { color:inherit; font-weight:500; }
    body.dark .schedule-training { color:#ccc; }
  </style>
</head>
<body class="p-3">
<div class="container-fluid">
  <div class="card mb-4">
    <div class="card-body text-center py-5">
      <h1 class="display-5 fw-bold text-primary">My LWA Training Record</h1>
      <p class="lead">Search your name below to view your current trainings</p>
      <div class="status-bar text-muted mb-3" id="status">Loading...</div>
      <div class="d-flex justify-content-center">
        <select id="employeeSelect" class="form-select w-auto" style="min-width:300px;">
          <option value="">— Select your name —</option>
        </select>
      </div>
    </div>
  </div>

  <div id="detailPane" class="card d-none">
    <div class="card-body">
      <div class="text-center text-muted py-5">
        <p class="fs-4">Select your name above to view your training status</p>
      </div>
    </div>
  </div>
</div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRMwtFhCZCDqPeWROrxXY6ytBvitNzyVKfGyNRQ5lfTXChyrqJDwBET4tRF4ocoSsafk0O0fUwoDxj6/pub?gid=1442283748&single=true&output=csv';

const LINKS = {
  "Fall Protection": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Personal Protective Equipment": "https://www.surveymonkey.com/r/LWAPPEQuiz",
  "Silica Awareness Training": "https://www.surveymonkey.com/r/LWASilicaDustExposure",
  "Silica Dust Exposure": "https://www.surveymonkey.com/r/LWASilicaDustExposure",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP",
  "Fire Prevention and Extinguishers": "https://www.surveymonkey.com/r/LWABasicFirePreventionQuiz"
};

let employeeMap = {}, allTopics = new Set();

async function loadData() {
  document.getElementById('status').innerHTML = 'Loading training data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error('Failed to load');
    const text = await resp.text();
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const records = lines.slice(1).map(line => {
      const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      const rec = {};
      headers.forEach((h, i) => rec[h] = vals[i] || '');
      return rec;
    }).filter(r => r['Employee Name'] && r['Topic']);

    // Build maps
    employeeMap = {};
    allTopics = new Set();
    records.forEach(r => {
      const orig = r['Employee Name'];
      const topic = r['Topic'];
      const norm = normalizeName(orig);
      if (!norm || !topic) return;
      allTopics.add(topic);
      if (!employeeMap[norm]) employeeMap[norm] = { original: orig, records: {} };
      employeeMap[norm].records[topic] = r;
    });

    populateEmployeeDropdown();
    document.getElementById('status').innerHTML = 'Select your name to view your trainings';
  } catch (err) {
    document.getElementById('status').innerHTML = '<span class="text-danger">Error loading data</span>';
  }
}

function normalizeName(name) {
  return name?.replace(/Perira/gi, 'Pereira')
    .replace(/Silviera/gi, 'Silveira')
    .replace(/[^\w\s]/g, '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') || '';
}

function parseTextDate(dateStr) {
  if (!dateStr) return 'N/A';
  const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const match = dateStr.match(/(\w{3})\s+(\d{1,2}),\s+(\d{4})/);
  if (match) {
    const [_, month, day, year] = match;
    return new Date(year, months[month], day).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    return new Date(parts[2], parts[0]-1, parts[1]).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  return dateStr || 'N/A';
}

function badge(r) {
  const s = r['Status'] || '';
  const days = r['Days Remaining'] || '';
  if (s === 'Completed') return `<span class="badge badge-comp">Completed</span>`;
  if (s === 'Not Due') return `<span class="badge badge-due">Not Due${days ? ' (' + days + 'd)' : ''}</span>`;
  if (s === 'Overdue') return `<span class="badge badge-over">Overdue${days ? ' (' + days + 'd)' : ''}</span>`;
  return `<span class="badge bg-secondary">${s || '—'}</span>`;
}

function populateEmployeeDropdown() {
  const sel = document.getElementById('employeeSelect');
  sel.innerHTML = '<option value="">— Select your name —</option>';
  Object.keys(employeeMap)
    .sort((a,b) => employeeMap[a].original.localeCompare(employeeMap[b].original))
    .forEach(norm => {
      const opt = document.createElement('option');
      opt.value = norm;
      opt.textContent = employeeMap[norm].original;
      sel.appendChild(opt);
    });
  sel.onchange = e => {
    if (e.target.value) showEmployeeDetail(e.target.value);
    else document.getElementById('detailPane').classList.add('d-none');
  };
}

function showEmployeeDetail(norm) {
  const emp = employeeMap[norm];
  if (!emp) return;
  const name = emp.original;
  let html = `<div class="card-body">
    <h3 class="text-center mb-4">${name}'s Training Record</h3>
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead><tr><th>Training Topic</th><th>Training Date</th><th>Completion Date</th><th>Expires</th><th>Days Left</th><th>Status</th></tr></thead>
        <tbody>`;

  Array.from(allTopics).sort((a,b) => a.localeCompare(b)).forEach(topic => {
    const r = emp.records[topic];
    let link = LINKS[topic] || Object.keys(LINKS).find(k => topic.includes(k) || k.includes(topic));
    const finalLink = link ? LINKS[link] : '';
    const cell = finalLink ? `<a href="${finalLink}" target="_blank" class="training-link">${topic}</a>` : topic;
    if (r) {
      html += `<tr>
        <td>${cell}</td>
        <td>${parseTextDate(r['Training Date'])}</td>
        <td>${parseTextDate(r['Completion Date'])}</td>
        <td>${parseTextDate(r['Expiration Date'])}</td>
        <td>${r['Days Remaining'] || '-'}</td>
        <td>${badge(r)}</td>
      </tr>`;
    } else {
      html += `<tr class="table-secondary">
        <td>${cell}</td>
        <td colspan="5"><span class="badge badge-norecord">No Record</span></td>
      </tr>`;
    }
  });

  html += `</tbody></table></div></div>`;
  document.getElementById('detailPane').innerHTML = html;
  document.getElementById('detailPane').classList.remove('d-none');
}

loadData();
</script>
</body>
</html>
